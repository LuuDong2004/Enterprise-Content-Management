<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<view xmlns="http://jmix.io/schema/flowui/view"
      title="Gán quyền truy cập">
    <data>
        <collection id="objectsDc"
                    class="com.vn.ecm.ecmmodule.entity.EcmObject">
        </collection>
        <collection id="permissionsDc" class="com.vn.ecm.ecmmodule.entity.Permission">
            <fetchPlan extends="_base">
                <property name="permissionType"/>
                <property name="user" fetchPlan="_base"/>
                <property name="roleCode"/>
            </fetchPlan>
            <loader id="permissionsDl">
                <query>
                    <![CDATA[
        select p from Permission p
        where
                    (:file is null or p.file = :file)
                    and (:folder is null or p.folder = :folder)
                    and (
                         (:user is null or p.user = :user)
                         or (:roleCode is null or p.roleCode = :roleCode)
                    )
    ]]>
                </query>
            </loader>
        </collection>
        <collection id="usersDc"
                    class="com.vn.ecm.ecmmodule.entity.User">
            <fetchPlan extends="_base">
                <property name="username"/>
            </fetchPlan>
            <loader id="usersDl" readOnly="true">
                <query>
                    <![CDATA[
                select u from User u
                join Permission p on p.user = u
                where
                    (:file is null or p.file = :file)
                    and (:folder is null or p.folder = :folder)
                ]]>
                </query>
            </loader>
        </collection>
        <collection id="rolesDc"
                    class="io.jmix.securitydata.entity.ResourceRoleEntity">
            <fetchPlan extends="_base">
                <property name="code"/>
                <property name="name"/>
            </fetchPlan>
            <loader id="rolesDl">
                <query>
                    <![CDATA[
                select r from sec_ResourceRoleEntity r
                where r.code in (
                    select p.roleCode from Permission p
                    where
                        (:file is null or p.file = :file)
                        and (:folder is null or p.folder = :folder)
                        and p.roleCode is not null
                )
                order by r.name
            ]]>
                </query>
            </loader>
        </collection>
    </data>
    <layout>
        <textArea id="pathArea" label="Đường dẫn: " readOnly="true" width="500px"/>
        <hbox spacing="true">
            <button id="usersBtn" text="Người dùng"/>
            <button id="rolesBtn" text="Phòng ban"/>
        </hbox>
        <vbox spacing="true" width="500px" height="400px">
            <dataGrid id="objectDataGrid" dataContainer="objectsDc" width="100%" height="200px">
                <columns>
                    <column property="name" header="Tên"/>
                    <column property="type" header="Kiểu"/>
                </columns>
            </dataGrid>
        </vbox>
        <hbox width="100%" justifyContent="BETWEEN" alignItems="CENTER">
            <span text="Nhấn “Chỉnh sửa” để thay đổi quyền truy cập"/>
            <button id="editBtn" text="Chỉnh sửa"/>
        </hbox>
        <vbox width="500px" height="237px">
            <dataGrid id="permissionDataGrid" dataContainer="permissionsDc" >
                <columns>
                    <column property="permissionType" header="Quyền truy cập" width="50%"/>
                </columns>
            </dataGrid>
        </vbox>
        <hbox spacing="true">
            <button id="advanceBtn" text="Nâng cao"/>
        </hbox>
    </layout>
</view>
