<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<view xmlns="http://jmix.io/schema/flowui/view"
      title="Gán quyền truy cập">
    <data>
        <collection id="objectsDc" class="com.vn.ecm.entity.EcmObject"/>
        <collection id="permissionsDc" class="com.vn.ecm.entity.Permission">
            <fetchPlan extends="_base">
                <property name="permissionType"/>
                <property name="user" fetchPlan="_base"/>
                <property name="roleCode"/>
            </fetchPlan>
            <loader id="permissionsDl">
                <query><![CDATA[
                    select p from Permission p
                    where
                        (:file is null or p.file = :file)
                        and (:folder is null or p.folder = :folder)
                        and (
                             (:user is null or p.user = :user)
                             or (:roleCode is null or p.roleCode = :roleCode)
                        )
                ]]></query>
            </loader>
        </collection>

        <collection id="usersDc" class="com.vn.ecm.entity.User">
            <fetchPlan extends="_base">
                <property name="username"/>
            </fetchPlan>
            <loader id="usersDl" readOnly="true">
                <query><![CDATA[
                    select u from User u
                    join Permission p on p.user = u
                    where
                        (:file is null or p.file = :file)
                        and (:folder is null or p.folder = :folder)
                ]]></query>
            </loader>
        </collection>

        <collection id="rolesDc" class="io.jmix.securitydata.entity.ResourceRoleEntity">
            <fetchPlan extends="_base">
                <property name="code"/>
                <property name="name"/>
            </fetchPlan>
            <loader id="rolesDl">
                <query><![CDATA[
                    select r from sec_ResourceRoleEntity r
                    where r.code in (
                        select p.roleCode from Permission p
                        where
                            (:file is null or p.file = :file)
                            and (:folder is null or p.folder = :folder)
                            and p.roleCode is not null
                    )
                    order by r.name
                ]]></query>
            </loader>
        </collection>
    </data>

    <layout>
        <textField id="pathArea" readOnly="true" width="100%"/>

        <!-- CHIA NGANG: Trái (danh sách) | Phải (phân quyền) -->
        <split id="mainSplit"
               orientation="HORIZONTAL"
               width="100%"
               height="92vh"
               splitterPosition="40">
            <!-- Panel trái: danh sách nhóm/người dùng -->
            <vbox id="leftPane"
                  width="100%" height="100%"
                  themeNames="spacing-s"
                  expand="objectDataGrid">
                <span text="Nhóm hoặc người dùng:"/>
                <dataGrid id="objectDataGrid" dataContainer="objectsDc" width="100%">
                    <columns>
                        <column property="name" header="Tên"/>
                    </columns>
                </dataGrid>
                <hbox width="100%" justifyContent="BETWEEN" alignItems="CENTER">
                    <span text="Nhấn “Chỉnh sửa” để thay đổi quyền"/>
                    <button id="editBtn" text="Chỉnh sửa"/>
                </hbox>
            </vbox>

            <!-- Panel phải: tiêu đề + nút + bảng phân quyền -->
            <vbox id="rightPane"
                  width="100%" height="100%"
                  themeNames="spacing-s"
                  expand="permissionDataGrid">
                <hbox width="100%" justifyContent="BETWEEN" alignItems="CENTER">
                    <!-- Tiêu đề sẽ được controller cập nhật theo lựa chọn -->
                    <span id="principalTitle" text="Quyền truy cập cho (chưa chọn)"/>
                    <hbox spacing="true">
                    </hbox>
                </hbox>

                <dataGrid id="permissionDataGrid" dataContainer="permissionsDc"
                          width="100%" minHeight="12em">
                    <columns>
                        <column property="permissionType" header="Quyền truy cập" width="50%"/>
                    </columns>
                </dataGrid>
                <hbox width="100%" justifyContent="END">
                    <button id="advanceBtn" text="Nâng cao"/>
                </hbox>
            </vbox>
        </split>
    </layout>
</view>
