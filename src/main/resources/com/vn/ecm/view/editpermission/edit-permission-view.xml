<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<view xmlns="http://jmix.io/schema/flowui/view"
      title="Chỉnh sửa quyền truy cập">
    <data>
        <!-- Giữ nguyên data và loader như hiện có để không ảnh hưởng logic -->
        <collection id="objectsDc" class="com.vn.ecm.entity.EcmObject"/>
        <collection id="permissionsDc" class="com.vn.ecm.entity.Permission">
            <fetchPlan extends="_base">
                <property name="permissionType"/>
                <property name="user" fetchPlan="_base"/>
                <property name="roleCode"/>
            </fetchPlan>
            <loader id="permissionsDl">
                <query><![CDATA[
                    select p from Permission p
                    where
                        (:file is null or p.file = :file)
                        and (:folder is null or p.folder = :folder)
                        and (
                             (:user is null or p.user = :user)
                             or (:roleCode is null or p.roleCode = :roleCode)
                        )
                ]]></query>
            </loader>
        </collection>

        <collection id="usersDc" class="com.vn.ecm.entity.User">
            <fetchPlan extends="_base">
                <property name="username"/>
            </fetchPlan>
            <loader id="usersDl" readOnly="true">
                <query><![CDATA[
                    select u from User u
                    join Permission p on p.user = u
                    where
                        (:file is null or p.file = :file)
                        and (:folder is null or p.folder = :folder)
                ]]></query>
            </loader>
        </collection>

        <collection id="rolesDc" class="io.jmix.securitydata.entity.ResourceRoleEntity">
            <fetchPlan extends="_base">
                <property name="code"/>
                <property name="name"/>
            </fetchPlan>
            <loader id="rolesDl">
                <query><![CDATA[
                    select r from sec_ResourceRoleEntity r
                    where r.code in (
                        select p.roleCode from Permission p
                        where
                            (:file is null or p.file = :file)
                            and (:folder is null or p.folder = :folder)
                            and p.roleCode is not null
                    )
                    order by r.name
                ]]></query>
            </loader>
        </collection>
    </data>

    <layout>
        <!-- Đường dẫn full width -->
        <textField id="pathArea" readOnly="true" width="100%"/>

        <!-- CHIA NGANG: Trái (danh sách) | Phải (phân quyền) -->
        <split id="mainSplit"
               orientation="HORIZONTAL"
               width="100%" height="100%"
               splitterPosition="32">

            <!-- Trái: danh sách Nhóm/Người dùng + ô tìm kiếm (tùy chọn dùng sau) -->
            <vbox id="leftPane" width="100%" height="100%" spacing="true" expand="objectDataGrid">
                <hbox width="100%" alignItems="CENTER" justifyContent="BETWEEN" spacing="true">
                    <span text="Nhóm hoặc người dùng:"/>
                </hbox>
                <dataGrid id="objectDataGrid" dataContainer="objectsDc" width="100%" height="100%">
                    <columns>
                        <column property="name" header="Tên" flexGrow="1"/>
                        <column property="type" header="Loại" width="140px"/>
                    </columns>
                </dataGrid>
                <hbox width="100%" justifyContent="BETWEEN" alignItems="CENTER">
                    <button id="addBtn" text="Thêm"/>
                </hbox>
            </vbox>

            <!-- Phải: tiêu đề + thao tác (Thêm/Lưu) + bảng phân quyền -->
            <vbox id="rightPane" width="100%" height="100%" spacing="true" expand="permissionDataGrid">
                <hbox width="100%" alignItems="CENTER" justifyContent="BETWEEN">
                    <span id="principalTitle" text="Quyền truy cập cho"/>
                </hbox>

                <dataGrid id="permissionDataGrid" dataContainer="permissionsDc" width="100%" height="100%" minHeight="14em">
                    <columns>
                        <column property="permissionType" header="Quyền truy cập" flexGrow="1"/>
                    </columns>
                </dataGrid>
                <hbox width="100%" justifyContent="END">
                    <button id="saveBtn" text="Lưu" themeNames="primary"/>
                </hbox>
            </vbox>
        </split>
    </layout>
</view>